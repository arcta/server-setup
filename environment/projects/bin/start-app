#!/bin/bash

########################################################################
### start project node-app
### parameters: $1 project subdirectory
########################################################################
source ~/.local.cnf

if [ -d "$HOME/projects/$1" ]; then
    project="$1"
    port=$(grep -P "(?<!\d)\d{4}\t${project}\t(?!\d)" ~/.project.cnf | cut -f1)

    if [[ -z "$port" || $port = \#* ]] ; then
        echo "${project} is DISABLED OR NOT IN ~/.project.cnf"
    else
        if [ -d "$HOME/projects/${project}/node-app" ]; then
            echo "Starting $project NodeJs-App on port $port ..."

            sudo tee /etc/nginx/upstream/app-$project <<EOF
        upstream app-$project {
            server 127.0.0.1:$port;
        }
EOF
            if [ "$project" = "node-app" ]; then
                location=$""
            else
                location=$project
            fi

            sudo tee /etc/nginx/location/app-$project <<EOF
        location projects/${location} {
            $ACCESS_PROJECT
            rewrite ^projects/${location}/(.*) /\$1 break;
            proxy_pass http://app-${project}/;
            include proxy_params;
        }
EOF
            cd ~/projects/${project}/node-app/
            pm2 start app.js --name $project
            cd -

            sudo systemctl restart nginx
        else
            echo "Abortnig: project $1 has no NodeJS-App"
        fi
    fi
else
    echo "Aborting: location projects/$1 does not exist"
fi
